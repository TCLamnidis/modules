nextflow_process {

    name "Test Process EGGNOGMAPPER"
    script "../main.nf"
    process "EGGNOGMAPPER"

    tag "modules"
    tag "modules_nfcore"
    tag "eggnogmapper"
    tag "diamond"
    tag "diamond/makedb"
    tag "mmseqs"
    tag "mmseqs/createdb"

    test("sarscov2 - proteome - diamond") {
        setup {
            run("DIAMOND_MAKEDB") {
                script "../../diamond/makedb/main.nf"
                process {
                    """
                    input[0] = [ [id:'dmnd_db'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                    input[1] = []
                    input[2] = []
                    input[3] = []
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = [ [id:'test'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                input[1] = DIAMOND_MAKEDB.out.db.map { _meta, db -> [ 'diamond', db ] }
                eggnog_db = file(params.modules_testdata_base_path + '/delete_me/eggnogmapper/eggnog.db', checkIfExists: true)
                eggnog_db.copyTo("${workDir}/tmp/eggnog.db")
                input[2] = "${workDir}/tmp/"
                """
            }
        }

        then {
            assert process.success
            assertAll(
                { assert snapshot(
                    file(process.out.annotations[0][1]).readLines()[3..6],
                    file(process.out.orthologs[0][1]).readLines()[5..18],
                    process.out.hits[0][1],
                    process.out.findAll { key, val -> key.startsWith("versions")}
                ).match() }
            )
        }

    }

    test("sarscov2 - proteome - mmseqs") {
        setup {
            run("MMSEQS_CREATEDB") {
                script "../../mmseqs/createdb/main.nf"
                process {
                    """
                    input[0] = [ [id:'mmseqs_db'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = [ [id:'test'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                input[1] = MMSEQS_CREATEDB.out.db.map { _meta, db -> [ 'mmseqs', db ] }
                eggnog_db = file(params.modules_testdata_base_path + '/delete_me/eggnogmapper/eggnog.db', checkIfExists: true)
                eggnog_db.copyTo("${workDir}/tmp/eggnog.db")
                input[2] = "${workDir}/tmp/"
                """
            }
        }

        then {
            assert process.success
            assertAll(
                { assert snapshot(
                    file(process.out.annotations[0][1]).readLines()[3..6],
                    file(process.out.orthologs[0][1]).readLines().size(),
                    file(process.out.hits[0][1]).readLines().size(),
                    process.out.findAll { key, val -> key.startsWith("versions")}
                ).match() }
            )
        }

    }

    test("sarscov2 - proteome - no_search") {
        setup {
            run("DIAMOND_MAKEDB") {
                script "../../diamond/makedb/main.nf"
                process {
                    """
                    input[0] = [ [id:'dmnd_db'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                    input[1] = []
                    input[2] = []
                    input[3] = []
                    """
                }
            }
            run("EGGNOGMAPPER", alias: "EGGNOGMAPPER_SETUP") {
                script "../main.nf"
                process {
                    """
                    input[0] = [ [id:'test'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                    input[1] = DIAMOND_MAKEDB.out.db.map { _meta, db -> [ 'diamond', db ] }
                    eggnog_db = file(params.modules_testdata_base_path + '/delete_me/eggnogmapper/eggnog.db', checkIfExists: true)
                    eggnog_db.copyTo("${workDir}/tmp/eggnog.db")
                    input[2] = "${workDir}/tmp/"
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = [ [id:'test'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                input[1] = EGGNOGMAPPER_SETUP.out.orthologs.map { _meta, orthologs -> [ 'no_search', orthologs ] }
                eggnog_db = file(params.modules_testdata_base_path + '/delete_me/eggnogmapper/eggnog.db', checkIfExists: true)
                eggnog_db.copyTo("${workDir}/tmp/eggnog.db")
                input[2] = "${workDir}/tmp/"
                """
            }
        }

        then {
            assert process.success
            assertAll(
                { assert snapshot(
                    file(process.out.annotations[0][1]).readLines()[3..6],
                    process.out.findAll { key, val -> key.startsWith("versions")}
                ).match() }
            )
        }

    }

    test("sarscov2 - proteome - diamond - stub") {
        options '-stub'
        setup {
            run("DIAMOND_MAKEDB") {
                script "../../diamond/makedb/main.nf"
                process {
                    """
                    input[0] = [ [id:'dmnd_db'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                    input[1] = []
                    input[2] = []
                    input[3] = []
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = [ [id:'test'], file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/proteome.fasta', checkIfExists: true) ]
                input[1] = DIAMOND_MAKEDB.out.db.map { _meta, db -> [ 'diamond', db ] }
                eggnog_db = file(params.modules_testdata_base_path + '/delete_me/eggnogmapper/eggnog.db', checkIfExists: true)
                eggnog_db.copyTo("${workDir}/tmp/eggnog.db")
                input[2] = "${workDir}/tmp/"
                """
            }
        }

        then {
            assert process.success
            assertAll(
                { assert snapshot(sanitizeOutput(process.out)).match() }
            )
        }

    }

}
